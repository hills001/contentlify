<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>
        How It Works
    </title>
    <link type="text/css" rel="stylesheet" href="./styles/portal.css" charset="UTF-8">
    <meta http-equiv="Content-Script-Type" content="text/javascript">
    <meta http-equiv="Content-Style-Type" content="text/css">
    <link href="./styles/Theme.gespp_microsite.css" type="text/css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/contentful@latest/dist/contentful.browser.min.js"></script>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script language="javascript" type="text/javascript">
        var exports = {}; // quick fix because 'exports' is not defined in rich-text bundle below
    </script>
    <script
        src="https://unpkg.com/@contentful/rich-text-html-renderer@12.0.0/dist/rich-text-html-renderer.es5.js"
        charset="utf-8"
    ></script>
    <script language="javascript" type="text/javascript">
        function markDownToHtmlString(markdown) {
            return new showdown.Converter().makeHtml(markdown);
        }

        var anchor = window.location.hash.split('/');

        var loadingRenderLock = 0;
        var vm;
        var entryType = "eep";

        // TODO: ensure we white-list these inputs
        var entryCode = anchor[1];
        var startLocale = anchor[2];

        var contentfulClient = contentful.createClient({
            space: '1mv2u22omsld',
            accessToken: '899769f9000215ba2d755e43bb5c4e525282c18553ec28b6faccf820f7a38258',
        });

        var companyCode = '4iB5Ogb9L3IH2fyUNi5IXs';

        function contentLoaded(data) {
            loadingRenderLock++;

            for (var f in data.fields) {
                if (data.fields[f].nodeType === "document") {
                    data.fields[f] = documentToHtmlString(data.fields[f]);
                } else if (typeof (data.fields[f]) === "string" && (data.fields[f].indexOf('\r') > -1 || data.fields[f].indexOf('\n') > -1)) {
                    data.fields[f] = markDownToHtmlString(data.fields[f]);
                }
            }

            vm.showDiagnostics = true
            vm.errorDetails = {};
            vm.content = data.fields;
            vm.loading = false;
            vm.error = false;
            vm.errorCount = 0;
        }

        function contentLoadError(error) {
            vm.error = true;
            vm.errorCount++;
            vm.errorDetails = error;
            if (error.response && error.response.data && typeof(error.response.data.message) === "string") {
                vm.errorMessage = error.response.data.message;
            } else {
                vm.errorMessage = "Unexpected / unknown error.";
            }
            setTimeout(loadContent, 1000);
        }


        function showLoadingOnSlowNetworksAfterMs(delay) {
            var rlock = loadingRenderLock;
            setTimeout(function(){
                if (rlock === loadingRenderLock) {
                    vm.loading = true;
                }
            }, delay);
        }

        function loadContent(locale) {
            showLoadingOnSlowNetworksAfterMs(1500);

            contentfulClient.getEntries({
                content_type: entryType,
                locale: locale,
                'fields.companyCode[in]': entryCode
                })
                .then(function(data){
                    if (data.items && data.items.length > 0) {
                        contentLoaded(data.items[0]);
                    } else {
                        contentLoadError({ response: { data: {message: "Content not found: " + entryType + " / " + entryCode, entries: data} } });
                    }
                }, contentLoadError);

            // contentfulClient.getEntry(companyCode, { locale: locale }).then(content, contentLoadError);
        }

        function init() {
            vm = new Vue( {
                el: '#app',

                data: {
                    loading: true,
                    error: false,
                    showDiagnostics: false,
                    errorMessage: "",
                    errorDetails: {},
                    errorCount: 0,
                    content: {},
                    locales: []
                }
            });

            contentfulClient.getLocales().then(function (data){
                data.items.push({ code: 'en-CA', name: 'English (Canada)' }); // TODO: delete this one line of demo code
                vm.locales = data.items;
            }, function (error){
                vm.locales = [{ code: 'en-US', name: 'English' }];
            });

            loadContent(startLocale);
        }
    </script>
</head>
<body>
<div class="page-wrapper" id="app">
    <div class="container" v-if="error">
        Error loading content (attempt {{errorCount}})... trying again...<br /><br />
        <pre>Details: {{errorMessage}}</pre>
        <pre>JSON: {{JSON.stringify(errorDetails, null, 2)}}</pre>
    </div>
    <div class="container" v-else-if="loading">
        Loading...
    </div>
    <div class="container" v-else>
        <div id="wtWhat" class="main-content">
            <div style="text-align: center;">
                <span v-for="locale in locales"><a href="#" v-bind:onclick="'loadContent(\'' + locale.code + '\'); event.preventDefault();'">{{ locale.name }}</a> &nbsp; </span>
            </div>
            <h1 class="page-title" >{{ content.heroMessageTitle }}</h1>
            <div class="main-content clearfix">
                <img class="img-left" 
                     v-bind:alt="content.heroImage.fields.title" 
                     v-bind:title="content.heroImage.fields.title"
                     v-bind:src="content.heroImage.fields.file.url"
                     v-bind:width="content.heroImage.fields.file.details.image.width"
                     v-bind:height="content.heroImage.fields.file.details.image.height" />
                <div>
                    <p v-html="content.heroMessage"></p>
                    <p v-html="content.longText"></p>
                    <p v-html="content.markDown"></p>
                    <p style="margin-bottom: 10px;" v-for="para in content.heroMessage.content">{{ para.content[0].value }}</p>
                </div>
            </div>
        </div>

        <ul id="wtNavContainer" class="site-nav">
            <li class="active">
                <div>
                    <a href="#">{{content.labelWhatIsIt}}</a>
                </div>
            </li>
            <li class="inactive"><a href="#">{{content.labelHowItWorks}}</a></li>
            <li class="inactive" v-if="content.planHasBonusShares"><a href="#">{{content.labelBonusShares}} ${{ content.bonusSharesAmount }}</a></li>
            <li class="inactive" v-if="content.showPlanRisks"><a href="#">{{content.labelWhatAreTheRisks}}</a></li>
            <li class="inactive"><a href="#">{{content.labelHowToJoin}}</a></li>
            <li class="inactive"><a href="#">{{content.labelFaQs}}</a></li>
            <li class="nav-join"><a href="#">{{content.labelJoin}}</a></li>
        </ul>
    </div>
    <div v-if="showDiagnostics">
        <h1>Diagnostics</h1>
        <pre>{{JSON.stringify(content, null, 2)}}</pre>
    </div>
</div>
<script language="javascript" type="text/javascript">
    init();
</script>
</body>
</html>
